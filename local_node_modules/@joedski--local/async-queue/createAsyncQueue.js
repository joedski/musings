const createDeferred = require('@joedski--local/deferred');

module.exports = function createAsyncQueue() {
  const $$ = {
    queue: [],
    enqueue() {
      const deferred = createDeferred();
      $$.queue.push(deferred);
      return deferred.promise;
    },
    resolveNext(res) {
      const nextDeferred = $$.queue.shift();
      if (nextDeferred) {
        nextDeferred.resolve(res);
      }
    },
    rejectNext(error) {
      const nextDeferred = $$.queue.shift();
      if (nextDeferred) {
        nextDeferred.reject(error);
      }
    },
    destroy() {
      $$.queue.forEach(deferred => deferred.resolve());
      $$.queue.length = 0;
    },
  };

  return $$;
}
