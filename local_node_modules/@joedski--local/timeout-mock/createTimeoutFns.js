module.exports = function createTimeoutFns() {
  const $$ = {
    id: 0,
    pending: [],
    setTimeout(fn, ms, ...args) {
      const entry = {
        id: ++$$.id,
        ms,
        fn,
        args,
      };
      $$.pending.push(entry);
      return entry.id;
    },
    clearTimeout(id) {
      const entryIndex = $$.pending.findIndex(e => e.id === id);
      if (entryIndex != null) {
        $$.pending.splice(entryIndex, 1);
      }
    },
    advanceTime(ms) {
      const expired = [];
      $$.pending.forEach((entry, i) => {
        entry.ms -= ms;
        if (entry.ms <= 0) {
          expired.push([i, entry]);
        }
      });
      expired.slice().reverse().forEach(([i]) => {
        $$.pending.splice(i, 1);
      });
      expired.forEach(([, entry]) => {
        entry.fn(...entry.args);
      });
    },
  };

  return $$;
}
